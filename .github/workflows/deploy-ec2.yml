name: PachangApp Despliegue Secuencial en EC2

# Disparadores
on:
  workflow_dispatch:

jobs:
  # 1. PROBAR (Igual que tu workflow original)
  test:
    name: 1. Instalar y Probar
    runs-on: ubuntu-latest
    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x' 
          cache: 'npm' 

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar pruebas (npm test)
        run: npm test

  # 2. CONSTRUIR ARTEFACTOS (Igual que tu workflow original)
  build:
    name: 2. Construir Artefactos
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x' 
          cache: 'npm' 

      - name: Instalar dependencias
        run: npm ci

      - name: Crear archivo de configuraci칩n JSDoc
        run: |
          cat <<EOT >> jsdoc.conf.json
          {
              "source": {
                  "include": ["src"], 
                  "includePattern": ".+\\\\.js(doc|x)?$",
                  "excludePattern": "(^|\\\\/|\\\\\\\\)_"
              },
              "opts": {
                  "encoding": "utf8",
                  "destination": "./docs",
                  "recurse": true
              }
          }
          EOT

      - name: Generar documentacion
        run: npm run docs

      # AQU칈 ESTA LA CLAVE: Subimos 'src' como el sitio est치tico.
      # Al descargarlo despu칠s, tendremos index.html en la ra칤z del artefacto.
      - name: Subir artefacto del sitio web
        uses: actions/upload-artifact@v4
        with:
          name: static-site
          path: src/ 

      - name: Subir artefacto de la documentaci칩n
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/
           
      - name: Subir artefacto de las im치genes 
        uses: actions/upload-artifact@v4
        with:
          name: images-folder
          path: images/

  # 3. DESPLEGAR EN EC2 (Modificado para usar SSH/SCP)
  deploy:
    name: 3. Desplegar en EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch'
    steps:
      # Preparamos una carpeta local 'deploy_package' para organizar todo antes de enviar
      - name: Preparar directorio de despliegue local
        run: mkdir -p deploy_package

      - name: Descargar sitio web (src)
        uses: actions/download-artifact@v4
        with:
          name: static-site
          path: ./deploy_package

      - name: Descargar documentaci칩n
        uses: actions/download-artifact@v4
        with:
          name: documentation
          path: ./deploy_package/docs
           
      - name: Descargar im치genes
        uses: actions/download-artifact@v4
        with:
          name: images-folder
          path: ./deploy_package/images

      - name: Preparar clave SSH
        run: |
          echo "${{ secrets.EC2_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Subir archivos al servidor EC2
        run: |
          echo "游 Subiendo archivos al servidor EC2..."
          # Enviamos todo el contenido de deploy_package a la carpeta home del usuario
          scp -i private_key.pem -r -o StrictHostKeyChecking=no ./deploy_package/* ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/temp_site/

      - name: Mover archivos a /var/www/html y limpiar
        run: |
          echo "游닍 Moviendo archivos al directorio web..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "\
            # 1. Borrar contenido antiguo (opcional, pero recomendado para limpieza)
            sudo rm -rf /var/www/html/* && \
            
            # 2. Mover los nuevos archivos desde la carpeta temporal
            sudo cp -r /home/${{ secrets.EC2_USER }}/temp_site/* /var/www/html/ && \
            
            # 3. Limpiar carpeta temporal
            rm -rf /home/${{ secrets.EC2_USER }}/temp_site && \
            
            # 4. Ajustar permisos (importante para que Nginx/Apache pueda leerlos)
            sudo chown -R www-data:www-data /var/www/html && \
            sudo chmod -R 755 /var/www/html"
